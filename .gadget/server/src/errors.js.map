{"version":3,"sources":["/app/packages/framework/src/errors.ts"],"sourceRoot":"/app","sourcesContent":["/** Bag of data details passed to an error */\ninterface ErrorDetails {\n  cause?: Error;\n  [key: string]: any;\n}\n\n/**\n * Parent class for all the enhanced errors in any gadget-owned package\n */\nclass GadgetError extends Error {\n  /** Was this error caused by the Gadget application's code */\n  causedByUserland = false;\n  /** Was this error caused by the API client calling the Gadget application */\n  causedByClient = false;\n  /** What HTTP status code should be sent when responding with this error */\n  statusCode = 500;\n  /** A GGT_SOMETHING human/machine readable string unique error class name */\n  code!: string;\n  /** If this error is thrown, should we allow its code, message, and details to be sent to the client. Defaults to true for errors with 400 series status codes and false otherwise. */\n  exposeToClient!: boolean;\n  /** If this error is thrown, should we allow its code, message, and details to be sent to the sandbox. Defaults to true. */\n  exposeToSandbox!: boolean;\n  /** Optional bag of data about this error */\n  details?: ErrorDetails;\n  /** Was this error already logged? */\n  logged = false;\n\n  /** Inner error which caused this error */\n  cause?: Error;\n\n  constructor(message: string = \"An internal error occurred.\", details?: ErrorDetails) {\n    super(message);\n    this.message = `${(this.constructor as any).code}: ${this.message}`;\n    this.details = details;\n    if (details?.cause) {\n      this.cause = details.cause;\n      delete details.cause;\n    }\n    this.name = this.constructor.name;\n  }\n}\n\nexport interface PermissionDeniedDetails extends ErrorDetails {\n  actor?: string | Record<string, any>;\n  actorRoleKeys?: string[];\n  resource?: Record<string, any>;\n}\n\n/** Thrown when an API client tries to access data that it's roles don't grant it access to. */\nexport class PermissionDeniedError extends GadgetError {\n  code = \"GGT_PERMISSION_DENIED\" as const;\n  static code = \"GGT_PERMISSION_DENIED\" as const;\n  statusCode = 403;\n  causedByClient = true;\n  causedByUserland = false;\n  actor?: string | Record<string, any>;\n  actorRoleKeys?: string[];\n  resource?: Record<string, any>;\n\n  constructor(message: string = \"Permission denied to access this resource.\", details: PermissionDeniedDetails = {}) {\n    super(message, details);\n    this.actor = details.actor;\n    this.actorRoleKeys = details.actorRoleKeys;\n    this.resource = details.resource;\n  }\n}\n\n/** Thrown when an action is trying to execute but can't because it's missing key configuration or some configuration value is itself invalid. This is the app developer's fault -- the action needs to be corrected in order to work. */\nexport class MisconfiguredActionError extends GadgetError {\n  code = \"GGT_MISCONFIGURED_ACTION\" as const;\n  static code = \"GGT_MISCONFIGURED_ACTION\" as const;\n  statusCode = 500;\n  causedByClient = false;\n  causedByUserland = true;\n\n  constructor(\n    message: string = \"Invalid action configuration, request cannot be processed until this is corrected.\",\n    details?: ErrorDetails\n  ) {\n    super(message, details);\n  }\n}\n\n/**\n * Catch all error thrown when something unexpected happens within the Gadget platform that isn't directly the app developer's fault.\n * Indicates that the error is the fault of the platform, and hides the details of why in case it might leak sensitive information.\n * Try not to use this as it isn't actionable by app developers, but if something really is our fault and out of their control, it's cool.\n */\nexport class InternalError extends GadgetError {\n  code = \"GGT_INTERNAL_ERROR\" as const;\n  static code = \"GGT_INTERNAL_ERROR\" as const;\n  statusCode = 500;\n  causedByClient = false;\n  causedByUserland = false;\n\n  constructor(message: string = \"An internal error occurred.\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n\nexport class InvalidActionInputError extends GadgetError {\n  code = \"GGT_INVALID_ACTION_INPUT\" as const;\n  static code = \"GGT_INVALID_ACTION_INPUT\" as const;\n  statusCode = 422;\n  causedByClient = true;\n  causedByUserland = false;\n\n  constructor(message: string = \"Input was invalid for an action\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n\nexport class InvalidStateTransitionError extends GadgetError {\n  code = \"GGT_INVALID_STATE_TRANSITION\" as const;\n  static code = \"GGT_INVALID_STATE_TRANSITION\" as const;\n  statusCode = 422;\n  causedByClient = false;\n  causedByUserland = true;\n\n  constructor(message: string = \"Invalid state transition\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n\nexport class UserNotSetOnSessionError extends GadgetError {\n  code = \"GGT_USER_NOT_SET_ON_SESSION\" as const;\n  static code = \"GGT_USER_NOT_SET_ON_SESSION\" as const;\n  statusCode = 401;\n  causedByClient = true;\n  causedByUserland = false;\n\n  constructor(message: string = \"User not set on session\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n\nexport class NoSessionForAuthenticationError extends GadgetError {\n  code = \"GGT_NO_SESSION_FOR_AUTHENTICATION\" as const;\n  static code = \"GGT_NO_SESSION_FOR_AUTHENTICATION\" as const;\n  statusCode = 401;\n  causedByClient = true;\n  causedByUserland = false;\n\n  constructor(message: string = \"There is no authenticated user in scope.\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n\n/** Represents what is thrown when an action can't be taken on a record because it's an illegal state transition */\nexport class NoTransitionError extends GadgetError {\n  code = \"GGT_NO_TRANSITION\" as const;\n  static code = \"GGT_NO_TRANSITION\" as const;\n  statusCode = 422;\n  causedByClient = true;\n  causedByUserland = false;\n\n  constructor(message: string = \"Invalid action\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n\nexport class GlobalNotSetError extends GadgetError {\n  code = \"GGT_GLOBAL_NOT_SET\" as const;\n  static code = \"GGT_GLOBAL_NOT_SET\" as const;\n  statusCode = 500;\n  causedByClient = false;\n  causedByUserland = false;\n\n  constructor(message: string = \"Globals not yet set\", details?: ErrorDetails) {\n    super(message, details);\n  }\n}\n"],"names":["GlobalNotSetError","InternalError","InvalidActionInputError","InvalidStateTransitionError","MisconfiguredActionError","NoSessionForAuthenticationError","NoTransitionError","PermissionDeniedError","UserNotSetOnSessionError","GadgetError","Error","causedByUserland","causedByClient","statusCode","code","exposeToClient","exposeToSandbox","details","logged","cause","constructor","message","name","actor","actorRoleKeys","resource"],"mappings":"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"}